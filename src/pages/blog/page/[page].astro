---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import Header from "../../../components/Header.astro";
import BlogCard from "../../../components/BlogCard.astro";
import BlogPagination from "../../../components/BlogPagination.astro";
import { getWpBase, listWpPostsPage } from "../../../utils/wp";

// Desactivamos prerender para evitar fallos de build cuando WP no responde o devuelve HTML
export const prerender = false;

const PER_PAGE = 9;

// Eliminado getStaticPaths: la paginación se resolverá en tiempo de ejecución (SSR)

const { page } = Astro.params;
const q = (Astro.url.searchParams.get('q') || '').trim();
const pageNum = Number(page || '1');

let current = pageNum;
let totalPages = 1;
let posts: any[] = [];

const wpBase = getWpBase();
if (!wpBase) {
  console.warn('[Blog] WP_API_BASE no configurado. Configure la variable en el servidor.');
} else {
  try {
    const { posts: wpPosts, totalPages: tp } = await listWpPostsPage(pageNum, PER_PAGE, q ? { search: q } : undefined);
    posts = wpPosts;
    totalPages = tp || 1;
  } catch (e) {
    console.error('[Blog] Error consultando WordPress:', e);
  }
}
---
<BaseLayout title={`Blog - Página ${current}${q ? ` - "${q}"` : ''} | Canvas Docente`}>
  <Fragment slot="header"><Header /></Fragment>
  <h1 class="sr-only">Blog</h1>
  <div class="mb-6">
    <label for="blog-search" class="sr-only">Buscar entradas</label>
    <div class="relative max-w-xl">
      <input id="blog-search" type="search" value={q} placeholder="Buscar por título o categoría..." class="w-full rounded-lg border border-slate-300 pl-10 pr-3 py-2 outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" />
      <svg class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
    </div>
  </div>
  {posts.length ? (
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {posts.map((post) => <BlogCard post={post} />)}
    </div>
  ) : (
    <div class="text-center text-slate-600 my-16">
      <p class="mb-2">No hay entradas disponibles.</p>
      <p class="text-sm">Verifique la conexión con WordPress o intente más tarde.</p>
    </div>
  )}
  <BlogPagination current={current} totalPages={totalPages} base={`/blog${q ? `?q=${encodeURIComponent(q)}` : ''}`} />
  <script>
    // @ts-nocheck
    (function(){
      function initSearchNav(){
        const input = document.getElementById('blog-search');
        if (!input) return;
        const base = '/blog';
        let timeout;
        function go(){
          const v = input.value.trim();
          const url = v ? `${base}?q=${encodeURIComponent(v)}` : base;
          window.location.href = url;
        }
        input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') go(); });
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initSearchNav);
      else initSearchNav();
    })();
  </script>
</BaseLayout>
