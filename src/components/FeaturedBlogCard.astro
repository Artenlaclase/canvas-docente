---
const { post } = Astro.props as { post: any };
// Resolver portada como en BlogCard
const assets = import.meta.glob('../assets/images/**/*', { eager: true, import: 'default' }) as Record<string, any>;
const coverPath = post.data.cover as string | undefined;
const isLocal = !!coverPath && (/^(\/|\.\/|\.\.\/)/.test(coverPath) || coverPath.startsWith('/src/'));

function resolveCover(path?: string): string | undefined {
  if (!path) return undefined;
  if (path.startsWith('/src/')) {
    const key = '..' + path.replace('/src', '');
    if (assets[key]) return typeof assets[key] === 'string' ? assets[key] : assets[key]?.src;
  }
  const idx = path.indexOf('assets/images/');
  if (idx !== -1) {
    const tail = path.slice(idx);
    const key = '..' + '/' + tail.replace(/^assets\//, 'assets/');
    if (assets[key]) return typeof assets[key] === 'string' ? assets[key] : assets[key]?.src;
  }
  const file = path.split('/').pop();
  if (file) {
    const match = Object.keys(assets).find((k) => k.endsWith('/' + file));
    if (match) return typeof assets[match] === 'string' ? assets[match] : assets[match]?.src;
  }
  return undefined;
}

function firstImageFromHtml(html?: string): string | undefined {
  if (!html || typeof html !== 'string') return undefined;
  const m = html.match(/<img[^>]+src=["']([^"']+)["']/i);
  return m?.[1];
}

const resolved = resolveCover(coverPath);
if (import.meta.env.DEV && coverPath && isLocal && !resolved) {
  console.warn(`[FeaturedBlogCard] No se pudo resolver la portada local: ${coverPath}.`);
}

const isWpPost = typeof post.id === 'number';
const fallbackHtmlImg = !coverPath && !isWpPost ? firstImageFromHtml(post.contentHtml) : undefined;
const displayCover = isWpPost ? (coverPath || undefined) : (resolved || coverPath || fallbackHtmlImg);
---
<a href={`/blog/${post.slug}`} class="group block rounded-xl overflow-hidden border border-slate-200 hover:shadow-lg transition bg-white">
  {displayCover ? (
    <img src={displayCover} alt={post.data.title || 'Imagen del artÃ­culo'} loading="lazy" class="aspect-[16/9] w-full object-cover group-hover:scale-[1.01] transition" />
  ) : null}
  <div class="p-6">
    <h2 class="text-2xl md:text-3xl font-bold leading-tight">{post.data.title}</h2>
    <p class="text-sm text-slate-500 mt-2">
      {post.data.author ? `Por ${post.data.author}` : new Date(post.data.date).toLocaleDateString('es')}
    </p>
    <p class="text-base md:text-lg text-slate-700 mt-3 line-clamp-3">{post.data.excerpt}</p>
  </div>
</a>
