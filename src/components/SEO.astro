---
/**
 * Componente SEO reutilizable
 * Genera metadatos dinámicos, Open Graph, Twitter Card y Schema.org JSON-LD
 */

export interface Props {
  title: string;
  description: string;
  url?: string;
  image?: string;
  imageAlt?: string;
  publishedTime?: string;
  modifiedTime?: string;
  tags?: string[];
  noIndex?: boolean;
  type?: 'article' | 'website' | 'artwork';
  author?: string;
  contentType?: string;
  locale?: string;
}

const {
  title,
  description,
  url,
  image,
  imageAlt = title,
  publishedTime,
  modifiedTime,
  tags = [],
  noIndex = false,
  type = 'website',
  author,
  contentType,
  locale = 'es_CL',
} = Astro.props as Props;

// Construir URLs absolutas
function makeAbsolute(u?: string): string | undefined {
  if (!u) return undefined;
  try {
    if (/^https?:\/\//i.test(u)) return u;
    const base = Astro.site?.toString() || '';
    if (!base) return u;
    return new URL(u, base).toString();
  } catch {
    return u;
  }
}

const absoluteUrl = makeAbsolute(url || Astro.url?.pathname || '/');
const absoluteImage = makeAbsolute(image);
const siteUrl = Astro.site?.toString() || '';
const authorName = author || 'Raúl Rosales';
const authorUrl = makeAbsolute('/sobre-mi');

// Determinar tipo de Open Graph según el contenido
const ogType = type === 'article' ? 'article' : type === 'artwork' ? 'image' : 'website';

// Construir Schema JSON-LD
const buildSchema = () => {
  const baseSchema: any = {
    '@context': 'https://schema.org',
    '@type': type === 'article' ? 'BlogPosting' : type === 'artwork' ? 'VisualArtwork' : 'WebPage',
    name: title,
    description: description,
    inLanguage: 'es-CL',
  };

  if (absoluteUrl) baseSchema.url = absoluteUrl;
  
  if (absoluteImage) {
    baseSchema.image = {
      '@type': 'ImageObject',
      url: absoluteImage,
      ...(imageAlt && { description: imageAlt }),
    };
  }

  if (author) {
    baseSchema.author = {
      '@type': 'Person',
      name: author,
      url: authorUrl,
    };
  }

  if (type === 'article') {
    baseSchema.datePublished = publishedTime || new Date().toISOString();
    if (modifiedTime) baseSchema.dateModified = modifiedTime;
  }

  if (type === 'artwork') {
    baseSchema.creator = {
      '@type': 'Person',
      name: author || authorName,
      url: authorUrl,
    };
  }

  return baseSchema;
};

const schemaData = buildSchema();
---

<!-- Metadatos básicos -->
<title>{title}</title>
<meta name="description" content={description} />
<meta name="generator" content={Astro.generator} />
<meta name="locale" content={locale} />

<!-- Indexación -->
{noIndex && <meta name="robots" content="noindex,follow" />}
{!noIndex && <meta name="robots" content="index,follow" />}

<!-- Canonical URL -->
{absoluteUrl && <link rel="canonical" href={absoluteUrl} />}

<!-- Open Graph para redes sociales -->
<meta property="og:type" content={ogType} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:site_name" content="Canvas Docente" />
<meta property="og:locale" content={locale} />
{absoluteUrl && <meta property="og:url" content={absoluteUrl} />}
{absoluteImage && <meta property="og:image" content={absoluteImage} />}
{absoluteImage && <meta property="og:image:alt" content={imageAlt} />}
{publishedTime && <meta property="article:published_time" content={publishedTime} />}
{modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
{author && <meta property="article:author" content={author} />}
{tags.length > 0 && tags.map(tag => <meta property="article:tag" content={tag} />)}

<!-- Twitter Card -->
<meta name="twitter:card" content={absoluteImage ? 'summary_large_image' : 'summary'} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
{absoluteImage && <meta name="twitter:image" content={absoluteImage} />}
<meta name="twitter:site" content="@canvasdocente" />

<!-- Schema.org JSON-LD para búsqueda enriquecida -->
<script type="application/ld+json" is:inline set:html={JSON.stringify(schemaData)} />
